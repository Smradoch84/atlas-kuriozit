<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Maska ČR + Interaktivní kraje + Formulář + Obce z JSON</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #formContainer {
      padding: 10px;
      background: #f0f0f0;
      max-width: 400px;
    }
    label { display: block; margin-top: 10px; position: relative; }
    input { width: 100%; padding: 5px; box-sizing: border-box; }
    button { margin-top: 10px; padding: 10px; width: 100%; cursor: pointer; }
    #entriesList { max-height: 150px; overflow-y: auto; margin-top: 10px; background: white; padding: 5px; border: 1px solid #ccc; }
    #map { height: calc(100% - 260px); }
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      border-top: none;
      z-index: 99;
      background: white;
      max-height: 150px;
      overflow-y: auto;
      width: 100%;
    }
    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
    }
    .autocomplete-items div:hover {
      background-color: #e9e9e9;
    }
  </style>
</head>
<body>

  <div id="formContainer">
    <h3>Vlož údaje</h3>
    <form id="dataForm" autocomplete="off">
      <label>Délka jazyka (cm):
        <input type="number" name="delkaJazyka" min="0" step="0.1" required />
      </label>
      <label>
        Obec:
        <input id="obecInput" type="text" name="obec" required />
        <div id="autocomplete-list" class="autocomplete-items"></div>
      </label>
      <button type="submit">Odeslat</button>
    </form>

    <h4>Zadaná data:</h4>
    <div id="entriesList"></div>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <script>
    // --- Mapa ---

    const map = L.map('map').setView([49.8, 15.5], 8);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap',
      maxZoom: 19
    }).addTo(map);

    // Maska ČR
    fetch('https://raw.githubusercontent.com/tvaliasek/CZ-GeoJSON/master/CZGeoJSON.json')
      .then(res => res.json())
      .then(czechFeature => {
        const feature = czechFeature.type === 'Feature'
          ? czechFeature
          : { type: 'Feature', geometry: czechFeature.features[0].geometry };

        const world = turf.polygon([[[-180, 90], [180, 90], [180, -90], [-180, -90], [-180, 90]]]);
        const mask = turf.difference(world, feature);

        L.geoJSON(mask, {
          style: {
            fillColor: 'white',
            fillOpacity: 1,
            stroke: false,
            interactive: false
          }
        }).addTo(map);

        L.geoJSON(feature, {
          style: {
            color: 'black',
            weight: 2,
            fillOpacity: 0,
            interactive: false
          }
        }).addTo(map);
      });

    // Krajské hranice
    fetch('https://raw.githubusercontent.com/Smradoch84/kraje/main/cz.json')
      .then(res => {
        if (!res.ok) throw new Error('Síťová odpověď nebyla OK');
        return res.json();
      })
      .then(kraje => {
        L.geoJSON(kraje, {
          style: {
            color: '#0074D9',
            weight: 1.5,
            fillOpacity: 0.1
          },
          onEachFeature: (feature, layer) => {
            const nazev = feature.properties.name || feature.properties.NAZ_CZNUTS3 || feature.properties.NAZEV || 'Neznámý kraj';
            layer.on('click', () => {
              layer.bindPopup(`<strong>${nazev}</strong>`).openPopup();
            });
          }
        }).addTo(map);
      })
      .catch(err => {
        console.error('Chyba při načítání krajů:', err);
        alert('Chyba při načítání krajů: ' + err.message);
      });

    // --- Obce ---

    let obce = []; // uložíme zde obecní data z JSON
    let obceNames = []; // jen jména obcí pro rychlé hledání

    // Normalizace textu (bez diakritiky, velká písmena)
    function normalize(text) {
      return (text || '')
        .normalize("NFD")
        .replace(/\p{Diacritic}/gu, "")
        .toUpperCase();
    }

    // Načti obce z githubu přes proxy kvůli CORS
    fetch('https://corsproxy.io/?https://raw.githubusercontent.com/Smradoch84/kraje/main/obce.json')
      .then(res => res.json())
      .then(data => {
        obce = data.features.map(f => ({
          name: f.properties.NAZ_OBEC,
          coords: [f.geometry.coordinates[1], f.geometry.coordinates[0]] // lat,lng
        }));
        obceNames = obce.map(o => o.name);
      })
      .catch(err => {
        console.error("Chyba načítání obcí:", err);
        alert("Nepodařilo se načíst seznam obcí.");
      });

    // --- Autocomplete ---

    const input = document.getElementById('obecInput');
    const autocompleteList = document.getElementById('autocomplete-list');

    input.addEventListener('input', function() {
      const val = normalize(this.value);
      autocompleteList.innerHTML = '';
      if (!val) return;

      // Najdi maximálně 20 obcí, které začínají na vstup
      const matches = obce.filter(o => normalize(o.name).startsWith(val)).slice(0, 20);

      matches.forEach(match => {
        const item = document.createElement('div');
        item.textContent = match.name;
        item.addEventListener('click', () => {
          input.value = match.name;
          autocompleteList.innerHTML = '';
        });
        autocompleteList.appendChild(item);
      });
    });

    // Zavři autocomplete pokud klikneš mimo input
    document.addEventListener('click', e => {
      if (e.target !== input) {
        autocompleteList.innerHTML = '';
      }
    });

    // --- Zpracování formuláře ---

    const markersGroup = L.layerGroup().addTo(map);
    const entries = [];
    const form = document.getElementById('dataForm');
    const entriesList = document.getElementById('entriesList');

    form.addEventListener('submit', e => {
      e.preventDefault();

      const formData = new FormData(form);
      const delkaJazyka = formData.get('delkaJazyka');
      const obecInput = formData.get('obec');

      // Najdi obec bez ohledu na diakritiku a velikost písmen
      const obecData = obce.find(o => normalize(o.name) === normalize(obecInput));
      if (!obecData) {
        alert('Obec nebyla nalezena v seznamu.');
        return;
      }

      const casVlozeni = new Date().toLocaleString('cs-CZ');

      const entry = {
        delkaJazyka,
        obec: obecData.name,
        casVlozeni,
        coords: obecData.coords
      };

      entries.push(entry);

      form.reset();
      autocompleteList.innerHTML = '';

      renderEntries();
      updateMapMarkers();
      map.setView(entry.coords, 10);
    });

    function renderEntries() {
      entriesList.innerHTML = '';
      entries.forEach(entry => {
        const div = document.createElement('div');
        div.innerHTML = `<strong>Obec:</strong> ${entry.obec} <br>
                         <strong>Délka jazyka:</strong> ${entry.delkaJazyka} cm <br>
                         <em>Vloženo: ${entry.casVlozeni}</em>`;
        entriesList.appendChild(div);
      });
    }

    function updateMapMarkers() {
      markersGroup.clearLayers();
      entries.forEach(entry => {
        const marker = L.marker(entry.coords).addTo(markersGroup);
        marker.bindPopup(`<strong>${entry.obec}</strong><br>Délka jazyka: ${entry.delkaJazyka} cm<br><em>Vloženo: ${entry.casVlozeni}</em>`);
      });
    }
  </script>

</body>
</html>
